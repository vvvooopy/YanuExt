<# ::1500
@echo off&pushd "%~dp0"&set "arg1=%~1"&set "arg2=%~2"&powershell -WindowStyle Hidden -c "iex ((Get-Content '%~f0' -Encoding utf8) -join [Environment]::Newline);YE"&exit
#>
function YE{[void][System.Reflection.Assembly]::LoadWithPartialName('System.Windows.Forms');function YEStart{$args_=@($env:arg1,$env:arg2);$cd=$pwd;$wdir="$cd\temp";$odir="$cd\out";$tdir="$cd\tools";$ndir="$tdir\nsz";$nbdir="$tdir\nscb";$key="$tdir\prod.keys";$hactoolnet="$env:localappdata\com.github.nozwock.yanu\hactoolnet.exe";$title='YanuExt';$version='1500';$yanu_rec='yanu-cli 0.10.1';$buttons='Обновление,Распаковка,Упаковка,Конвертирование,Задания,Создание multi-NSP'.Split(',');if($null-ne($git=(Invoke-RestMethod 'https://raw.githubusercontent.com/vvvooopy/yanuext/main/YanuExt.bat'))-and$git.Split("`n")[0].Replace('<# ::','').Trim()-gt$version){if((YEmsg "Доступно обновление $title.`nОбновить?" 'YesNo')-eq'Yes'){Copy-Item -Force -Path "$cd\$title.bat" -Destination "$cd\$title($version).bat";[void](New-Item -Force -Path "$cd\$title.bat" -Value $git);Start-Process -FilePath 'cmd' -ArgumentList "/c timeout 2&start $title.bat&exit" -WindowStyle Hidden;exit}}if((0-in(Test-Path $tdir,$ndir,$nbdir))){[void](New-Item -ItemType Directory -Force $ndir,$nbdir)}if($null-eq($yanu=(Get-Item "$tdir\*yanu*cli*.exe").Name)){if((YEmsg "yanu в папке `"tools`" не найден.`nВ имени файла должны быть `"yanu`", `"cli`" и `".exe`".`nОткрыть страницу загрузки?" 'YesNo')-eq'Yes'){Start-Process 'https://github.com/nozwock/yanu/releases'}exit}if(!(Test-Path $key)){YEmsg 'Файл "prod.keys" в папке "tools" не найден.';exit}if(($yanu_v=&"$tdir\$yanu" -V)-ne$yanu_rec){YEmsg "Рекомендуемая версия yanu: $yanu_rec`nТекущая: $yanu_v"}if(Test-Path 'yanu.log.*'){Remove-Item -Force 'yanu.log.*'}if(!($nsz_f=Test-Path "$ndir\nsz.exe")){if((YEmsg "NSZ в папке `"tools\nsz`" не найден, конвертирование отключено.`nОткрыть страницу загрузки?" "YesNo")-eq'Yes'){Start-Process 'https://github.com/nicoboss/nsz/releases';exit}}if(!($nscb_f=Test-Path "$nbdir\NSCB.bat")){if((YEmsg "NSCB в папке `"tools\nscb`" не найден, создание мульти-NSP отключено.`nОткрыть страницу загрузки?" "YesNo")-eq'Yes'){Start-Process 'https://github.com/julesontheroad/NSC_BUILDER/releases';exit}}if(!($htn_f=Test-Path $hactoolnet)){YEmsg "Не найден `"hactoolnet`". Для исправления можно запустить распаковку NSP и перезапустить $title.`nУпаковка, распаковка NCA и romfs.bin недоступны."}if($null-ne$env:arg1){YEFast}else{YEGUI}}function YEGUI{$functions='YEUpdate,YEUnpack,YEPack,YEConvert,YETasks'.Split(',');$f=New-Object Windows.Forms.Form;$f.AutoSize=1;$f.AutoSizeMode=0;$f.BackColor='White';$f.ForeColor='Black';$f.FormBorderStyle=3;$f.MaximizeBox=0;$f.StartPosition=1;$f.Text=$title;$f.TopMost=1;$i=0;$buttons.ForEach({$b=New-Object Windows.Forms.Button;$b.Bounds='8,'+(8+38*$i)+',200,30';$b.Name=0+$i;$b.Text=$_;$b.Add_Click({if($bh.Visible-and$this.Text-ne$buttons[-2]){$f.Controls.ForEach({if($_-notmatch'Button'-and$_.Name-eq$this.Name){$_.Visible=1}if($_-match'Button'){if($_.Name-eq$this.Name){$_.BackColor='#B6C8CA'}else{$_.BackColor='#E0F7FA'}}});$f.Controls.ForEach({if($_-notmatch'Button'-and$_.Name-ne$this.Name){$_.Visible=0}})}else{&$functions[$this.Name]}});if($_-eq$buttons[-1]){$b.Visible=0}$f.Controls.Add($b);if($_-ne$buttons[-2]){$gb=New-Object Windows.Forms.GroupBox;$gb.Bounds='215,3,382,264';$gb.Name=0+$i;$gb.Visible=0;$f.Controls.Add($gb);$ckbx=New-Object Windows.Forms.CheckBox;$ckbx.BackColor='#E0F7FA';$ckbx.Bounds='9,0,11,11';$ckbx.FlatStyle=0;$ckbx.Add_Click({YECBHandler});$gb.Controls.Add($ckbx);for($n=0;$n-lt'2';$n++){$vls=if($i-lt'2'){if($n-eq'0'){'9,28,363,105','9,13','Базовые'}else{'9,150,363,105','9,135','Обновления'}}elseif($i-eq'2'){'9,28,363,226','9,13','Папки'}elseif($i-eq'3'){'9,28,363,226','9,13','NSZ, XCI'}else{'9,28,363,226','9,13','NSP, XCI, NSZ, XCZ'}if(!($i-in(2..5)-and$n-eq'1')){$ltbx=New-Object Windows.Forms.ListBox;$ltbx.AllowDrop=1;$ltbx.BackColor='#E0F7FA';$ltbx.BorderStyle=1;$ltbx.Bounds=$vls[0];$ltbx.DisplayMember='Name';$ltbx.HorizontalScrollbar=1;$ltbx.IntegralHeight=0;$ltbx.SelectionMode=3;$ltbx.Add_DragEnter({$_.Effect=1});$ltbx.Add_DragDrop({YEDDHandler});$ltbx.Add_MouseUP({YELBCHandler});$lbl=New-Object Windows.Forms.Label;$lbl.Location=$vls[1];$lbl.Text=$vls[2];$lbl.AutoSize=1}$gb.Controls.AddRange(($ltbx,$lbl))}}$i++});$bh=New-Object Windows.Forms.Button;$bh.Bounds='8,236,30,30';$bh.Text='?';$bh.Visible=0;$bh.Add_Click({YEmsg "Добавить объекты: перетащить их мышкой в список.`n`nУдалить объекты: выделить их в списке и нажать ПКМ.`n`nИзменить отображение объектов в списке: нажать СКМ по списку."});$bs=New-Object Windows.Forms.Button;$bs.Bounds='46,236,162,30';$bs.Text='Начать';$bs.Visible=0;$bs.Add_Click({$tcb=$f.Controls.Controls.Checked;if($tcb[0]){$lbb=$f.Controls[1].Controls[1].Items;$lbu=$f.Controls[1].Controls[3].Items;if($lbb.Count-ne'0'-and$lbu.Count-ne'0'){for($i=0;$i-lt$lbb.Count;$i++){if($null-ne$lbu[$i]){$base,$update=$lbb[$i],$lbu[$i];YEUpdate;$rlb+=@($lbb[$i]);$rlu+=@($lbu[$i]);Start-Sleep 5}}for($i=0;$i-lt$rlb.Count;$i++){$lbb.Remove($rlb[$i]);$lbu.Remove($rlu[$i])}}}if($tcb[1]){$lbb=$f.Controls[3].Controls[1].Items;$lbu=$f.Controls[3].Controls[3].Items;if($lbb.Count-ne'0'){for($i=0;$i-lt$lbb.Count;$i++){$base,$update=$lbb[$i],$lbu[$i];YEUnpack;$rlb+=@($lbb[$i]);$rlu+=@($lbu[$i]);Start-Sleep 5}for($i=0;$i-lt$($rlb.Count);$i++){$lbb.Remove($rlb[$i]);$lbu.Remove($rlu[$i])}}}if($tcb[2]){$lb=$f.Controls[5].Controls[1].Items;if($lb.Count-ne'0'){$lb.ForEach({$pdir=$_;YEPack;Start-Sleep 3});while($lb){$lb.Remove($lb[0])}}}if($tcb[3]){$lb=$f.Controls[7].Controls[1].Items;if($lb.Count-ne'0'){$lb.ForEach({$csf=$_;YEConvert;Start-Sleep 3});while($lb){$lb.Remove($lb[0])}}}if($tcb[4]){$lb=$f.Controls[9].Controls[1].Items;if($lb.Count-ne'0'){YEStartTask multi $lb.FullName;while($lb){$lb.Remove($lb[0])}}}});$f.Controls.AddRange(($bh,$bs));$f.Controls.ForEach({$_.Margin=8;if($_-match'Button'){$_.BackColor='#E0F7FA';$_.Cursor='Hand';$_.FlatStyle=0}});[void]$f.ShowDialog()}function YEFast{if((Get-Item -LiteralPath $($args_[0])).PSIsContainer){$pdir=$args_[0];YEPack}else{if((Get-Item -LiteralPath $args_[0]).Extension-notin'.nsp','.nsz','.xci'){YEmsg "Неизвестное расширение файла.`n$args_";exit}elseif((Get-Item -LiteralPath $args_[0]).Extension-eq'.nsp'){$base=$args_[0];if($null-ne$args_[1]-and(Get-Item -LiteralPath $args_[1]).Extension-eq'.nsp'){$update=$args_[1]}YEUnpack}else{$csf=$args_[0];YEConvert}}}function YEUpdate{if($null-eq$base){$base=YEFiles 'Выберите базовый файл' 'NSP|*.nsp';if($null-ne$base){$update=YEFiles 'Выберите файл обновления' 'NSP|*.nsp';if($base-eq$update){YEmsg 'Выбран один файл.';return}}}if($null-ne$base-and$null-ne$update){YEStartTask update "--base `"$base`" --update `"$update`""}}function YEUnpack{if($null-eq$base){$base=YEFiles "Выберите базовый файл$(if($htn_f){', NCA или romfs.bin'})" "NSP|*.nsp$(if($htn_f){'|NCA|*.nca|BIN|*.bin'})";if($null-ne$base-and(Get-Item -LiteralPath $base).Extension-eq'.nsp'){$update=YEFiles 'Выберите файл обновления' 'NSP|*.nsp';if($base-eq$update){YEmsg 'Выбран один файл как базовый и обновление, распакуется только базовый.';$update=$null}}}if($null-ne$base){if(($baseext=(Get-Item -LiteralPath $base).Extension)-eq'.nsp'){$unpd='\'+(Get-Item -LiteralPath $base).Basename;if($null-ne$update){$unpd=$unpd+'+'+(Get-Item -LiteralPath $update).Basename;$update=' --update '+'"'+$update+'"'}YEStartTask unpack "--base `"$base`"$update" $unpd}elseif($baseext-eq'.nca'){YEStartTask unpacknca $base "\unpacked_nca\$((Get-Item -LiteralPath $base).Basename)"}else{YEStartTask unpackrfs $base '\unpacked_romfs'}}}function YEPack{if($null-eq$pdir){$pdir=YEFolder}if($null-ne$pdir){if(Test-Path -LiteralPath "$pdir\basedata"){$pdata="$pdir\"+$(if(Test-Path -LiteralPath "$pdir\updatedata"){'update'}else{'base'})+'data'}else{YEmsg "Папка не содержит данных для упаковки.`n$pdir";return}$controlnca=if($htn_f){$fn=Get-ChildItem -LiteralPath "$pdata" -Filter *.nca;foreach($cn in $fn){if($null-ne(&"$hactoolnet" "-k" "$key" "$($cn.FullName)"|Select-String 'Control')){"$($cn.FullName)";break}}}else{YEmsg 'Не найден "hactoolnet", возможно распаковка NSP и перезапуск поможет.';return}if($null-eq$controlnca){YEmsg 'Не найден подходящий nca.';return}$titleid = (&"$hactoolnet" "-k" "$key" "$controlnca"|Select-String 'TitleID'|Out-String).Replace('TitleID:','').Trim();if($null-eq$titleid){YEmsg 'Не найден подходящий TitleID';return}YEStartTask pack "--controlnca `"$controlnca`" --titleid `"$titleid`" --romfsdir `"$pdir\romfs`" --exefsdir `"$pdir\exefs`""}}function YEConvert{if($null-eq$csf){$csf=YEFiles 'Выберите файл' "$(if($nsz_f){'NSZ|*.nsz|'})XCI|*.xci"}if($null-ne$csf){if((Get-Item -LiteralPath $csf).Extension-eq'.xci'){YEStartTask convert "--kind nsp `"$csf`""}else{YEStartTask convertnsz $csf}}}function YEStartTask{param($task,$com,$unpd)$name,$color=switch($task){'update'{$buttons[0],'DarkYellow'}'unpack'{$buttons[1],'DarkRed'}'unpackrfs'{$buttons[1],'DarkRed'}'unpacknca'{$buttons[1],'DarkRed'}'pack'{$buttons[2],'DarkGreen'}'convert'{$buttons[3],'DarkCyan'}'convertnsz'{$buttons[3],'DarkCyan'}'multi'{$buttons[-1],'DarkMagenta'}}$rnd=YERnd;$odir=$odir+$unpd;if(!(Test-Path $odir)){[void](New-Item -ItemType Directory -Force "$odir")}$com=if($task-in'update','unpack','pack','convert'){$task_yanu=1;$path="$wdir\${task}_$rnd";[void](New-Item -ItemType Directory -Force "$path");Copy-Item -Path "$tdir\$yanu" -Destination $path;Push-Location -Path $path;"`"$path\$yanu`" -k `"$key`" $task $com -o `"$odir`"&echo.&pause&cd `"$cd`"&rd /q /s `"$path`"&((for /f %a in ('dir /b /a .\temp\*') do exit)||rd /q /s `"$wdir`")"}elseif($task-eq'convertnsz'){if($nsz_f){Copy-Item -Path $key -Destination "$ndir\keys.txt";"`"$ndir\nsz.exe`" -D `"$com`" -o `"$odir`"&echo.&pause"}}elseif($task-eq'unpackrfs'){if($htn_f){"`"$hactoolnet`" -k `"$key`" -t romfs `"$com`" --romfsdir `"$odir\$rnd`"&echo.&pause"}}elseif($task-eq'unpacknca'){if($htn_f){"`"$hactoolnet`" -k `"$key`" `"$com`" --romfsdir `"$odir\romfs`" --exefsdir `"$odir\exefs`"&echo.&pause"}}elseif($task-eq'multi'){if($nscb_f){$task_multi=1;$path="$odir\${task}_$rnd";[void](New-Item -Force -Path "$path\list" -Value ($com|Out-String));Push-Location -Path "$tdir\nscb";Copy-Item -Path $key -Destination "ztools\keys.txt";"`"$tdir\nscb\ztools\squirrel.exe`" -b 65536 -pv false -kp false --RSVcap 268435656 -fat exfat -fx files -ND true -t cnsp -o `"$path`" -tfile `"$path\list`" -roma TRUE -dmul `"calculate`"&echo.&pause"}}else{return}if($null-eq$com){return}Start-Process -FilePath 'cmd' -ArgumentList "/q /c title $title - $name... [id: $rnd]&$com";if($task_yanu-or$task_multi){Pop-Location}Write-Host -BackgroundColor $color -ForegroundColor 'Black' "Задача запущена: $name(id: $rnd)"}function YETasks{if($bh.Visible){$bh.Visible=0;$bs.Visible=0;$f.Controls.ForEach({if($_-match'GroupBox'){$_.Visible=0}if($_-match'Button'){$_.BackColor='#E0F7FA';if($_-match$buttons[-1]){$_.Visible=0}}});$f.Controls.Controls.ForEach({if($_-match'CheckBox'){$_.Checked=0}})}else{$bh.Visible=1;$gb.Visible=1;$f.Controls.ForEach({if($_-match$buttons[-1]){$_.Visible=1;$_.BackColor='#B6C8CA'}});$f.Controls.Controls.ForEach({if($_-notmatch'CheckBox'){$_.Visible=0}})}}function YERnd{while(1){$rnd=Get-Random;if(!(Test-Path "$wdir\*$rnd")){return $rnd}}}function YEFiles{param($title,$filter)$of=New-Object Windows.Forms.OpenFileDialog;$of.Title=$title;$of.Filter=$filter;if($of.ShowDialog()-eq'OK'){return $of.FileName}}function YEFolder{$d=New-Object Windows.Forms.FolderBrowserDialog;$d.SelectedPath=if($null-ne($sp=(Get-Childitem -LiteralPath $odir -Directory).FullName)){$sp.Split('"')[0]}else{$odir}$d.ShowNewFolderButton=0;if($d.ShowDialog()-eq'OK'){return $d.SelectedPath}}function YEmsg{param($msg,$btns='OK')[Windows.Forms.MessageBox]::Show($msg,$title,$btns,'Info')|Where-Object({if(!($btns-eq'OK')){return $_}})}function YEDDHandler{param($ext=0)$__=$_;$slbi=$this.Parent.Controls.ForEach({if($this-ne$_){$_.Items.FullName}});$ext=switch($this.Parent.Name){$f.Controls.Name[1]{'.nsp'}$f.Controls.Name[3]{'.nsp'}$f.Controls.Name[5]{'dir'}$f.Controls.Name[7]{'.xci,.nsz'}$f.Controls.Name[9]{'.nsp,.xci,.nsz,.xcz'}default{$ext}}if($ext-ne0){$ext=$ext.Split(',')}$__.Data.GetData('FileDrop').ForEach({if((Get-Item -LiteralPath $_).Extension-in$ext-or((Get-Item -LiteralPath $_).PSIsContainer-and'dir'-in$ext)-or$ext-eq0){if($_-notin$this.Items.FullName-and$_-notin$slbi){$this.Items.Add((Get-Item -LiteralPath $_))}}})}function YELBCHandler{if($_.Button-eq'Right'){while($this.SelectedItem){$this.Items.Remove($this.SelectedItem)}}elseif($_.Button-eq'Middle'){$this.DisplayMember=if($this.DisplayMember-eq'Name'){'FullName'}else{'Name'}}}function YECBHandler{$bs.Visible=if(1-in$f.Controls.Controls.Checked){1}else{0}$this.Parent.Controls.ForEach({if($this.Checked){if($_-ne$this){$_.Visible=1}}else{if($_-ne$this){$_.Visible=0}}})}YEStart}